<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>狼人杀房间 - 自定义角色版</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; }
    .container { display: flex; gap: 20px; margin-top: 20px; }
    .chat-panel { flex: 1; border: 1px solid #ccc; border-radius: 8px; padding: 15px; height: 500px; display: flex; flex-direction: column; }
    .room-info { flex: 1; border: 1px solid #ccc; border-radius: 8px; padding: 15px; }
    .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 4px; }
    .chat-input { display: flex; gap: 10px; }
    .voice-btn { background: #28a745; }
    .voice-btn:hover { background: #218838; }
    .player-list { margin-top: 10px; padding: 10px; border: 1px solid #eee; border-radius: 4px; }
    .rule-edit { margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 4px; background: #f9f9f9; }
    .message { margin: 5px 0; padding: 8px; border-radius: 4px; }
    .my-message { background: #e3f2fd; text-align: right; }
    .other-message { background: #f5f5f5; text-align: left; }
    .voice-message { background: #fff8e1; padding: 10px; display: flex; align-items: center; gap: 10px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <div class="header">
    <h1>房间号：<span id="roomId"></span></h1>
    <div>
      昵称：<span id="nickname"></span> | 
      <button onclick="leaveRoom()">离开房间</button>
    </div>
  </div>

  <div class="container">
    <!-- 聊天面板（打字+语音） -->
    <div class="chat-panel">
      <h3>聊天区域</h3>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="输入聊天内容..." style="flex: 1; padding: 8px;">
        <button onclick="sendChat()">发送</button>
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecord()">按住说话</button>
      </div>
      <audio id="audioPlayer" controls style="display: none; margin-top: 10px;"></audio>
    </div>

    <!-- 房间信息+规则面板 -->
    <div class="room-info">
      <h3>房间信息</h3>
      <p>当前人数：<span id="playerCount">1</span>/<span id="maxPlayers">13</span></p>
      <div class="player-list">
        <h4>玩家列表</h4>
        <ul id="playerList"></ul>
      </div>

      <!-- 规则展示（所有人可见） -->
      <div style="margin-top: 20px;">
        <h3>当前游戏规则</h3>
        <p>白天发言时间：<span id="daySpeakTime">90</span>秒</p>
        <p>遗言时间：<span id="lastWordTime">20</span>秒</p>
        <p>首夜狼人可刀：<span id="canWolfKill">是</span></p>
      </div>

      <!-- 房主规则修改面板（仅房主单独在房间时显示） -->
      <div id="ruleEditPanel" class="rule-edit" style="display: none;">
        <h3>修改自定义规则</h3>
        人数上限：<input type="number" id="editMaxPlayers" min="10" max="15" value="13"><br><br>
        白天发言时间（秒）：<input type="number" id="editDaySpeakTime" min="60" max="180" value="90"><br><br>
        遗言时间（秒）：<input type="number" id="editLastWordTime" min="10" max="30" value="20"><br><br>
        首夜狼人可刀：<select id="editCanWolfKill">
          <option value="true">是</option>
          <option value="false">否</option>
        </select><br><br>
        <button onclick="saveRules()">保存规则</button>
        <div id="ruleMsg" style="margin-top: 10px; color: green;"></div>
      </div>

      <!-- 开始游戏按钮（房主可见，人数满员时启用） -->
      <button id="startGameBtn" style="margin-top: 20px; padding: 10px 20px; background: #ffc107; color: #333; font-size: 16px;" disabled>等待玩家加入...</button>
    </div>
  </div>

  <script>
    // 获取URL参数
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('roomId');
    const nickname = params.get('nickname');
    const isHost = params.get('isHost') === 'true';

    // 初始化页面
    document.getElementById('roomId').textContent = roomId;
    document.getElementById('nickname').textContent = nickname;

    // WebSocket连接
    let ws = new WebSocket('wss://你的服务器IP:3000'); // 替换为你的服务器地址
    let mediaRecorder = null;
    let audioChunks = [];

    // 连接成功
    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: 'joinRoom',
        roomId: roomId,
        nickname: nickname
      }));
    };

    // 接收消息
    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      handleMessage(data);
    };

    // 处理所有服务器消息
    function handleMessage(data) {
      switch (data.type) {
        case 'playerJoin':
          document.getElementById('playerCount').textContent = data.playerCount;
          updatePlayerList(data.nickname);
          addChatMessage(`系统消息：${data.nickname}加入房间`, 'system');
          checkStartGameBtn(data.playerCount);
          break;
        case 'playerLeave':
          addChatMessage(`系统消息：${data.message}`, 'system');
          updatePlayerList();
          break;
        case 'chatBroadcast':
          const isMyMsg = data.nickname === nickname;
          addChatMessage(`${data.nickname}（${data.time}）：${data.content}`, isMyMsg ? 'my' : 'other');
          break;
        case 'voiceBroadcast':
          addVoiceMessage(data.nickname, data.time, data.voiceId);
          break;
        case 'currentRules':
          updateRuleDisplay(data);
          break;
        case 'ruleUpdateSuccess':
          document.getElementById('ruleMsg').textContent = '规则修改成功！';
          updateRuleDisplay(data.currentRules);
          break;
        case 'ruleUpdateFail':
          document.getElementById('ruleMsg').textContent = data.message;
          document.getElementById('ruleMsg').style.color = 'red';
          break;
        case 'gameNotice':
          addChatMessage(`【游戏通知】${data.message}`, 'system');
          break;
        case 'assignRole':
          alert(`角色分配完成！你是【${data.role}】（${data.faction}）\n技能：${data.skillDesc}`);
          window.location.href = `game.html?roomId=${roomId}&nickname=${nickname}&role=${data.role}`;
          break;
      }
    }

    // 更新玩家列表
    function updatePlayerList(newPlayer = '') {
      const list = document.getElementById('playerList');
      if (newPlayer) {
        const li = document.createElement('li');
        li.textContent = newPlayer + (newPlayer === nickname ? '（你）' : '');
        list.appendChild(li);
      } else {
        // 简化逻辑：实际应从服务器获取完整列表，这里仅作演示
        list.innerHTML = '';
      }
    }

    // 更新规则展示
    function updateRuleDisplay(rules) {
      document.getElementById('maxPlayers').textContent = rules.maxPlayers;
      document.getElementById('daySpeakTime').textContent = rules.daySpeakTime;
      document.getElementById('lastWordTime').textContent = rules.lastWordTime;
      document.getElementById('canWolfKill').textContent = rules.canWolfKillFirstNight ? '是' : '否';

      // 房主单独在房间时显示编辑面板
      if (isHost && document.getElementById('playerCount').textContent === '1') {
        document.getElementById('ruleEditPanel').style.display = 'block';
        document.getElementById('editMaxPlayers').value = rules.maxPlayers;
        document.getElementById('editDaySpeakTime').value = rules.daySpeakTime;
        document.getElementById('editLastWordTime').value = rules.lastWordTime;
        document.getElementById('editCanWolfKill').value = rules.canWolfKillFirstNight;
      }
    }

    // 检查开始游戏按钮状态
    function checkStartGameBtn(playerCount) {
      const maxPlayers = parseInt(document.getElementById('maxPlayers').textContent);
      const btn = document.getElementById('startGameBtn');
      if (isHost && playerCount === maxPlayers) {
        btn.disabled = false;
        btn.textContent = '开始游戏';
        btn.onclick = startGame;
      }
    }

    // 发送聊天消息
    function sendChat() {
      const content = document.getElementById('chatInput').value.trim();
      if (!content) return;
      ws.send(JSON.stringify({
        type: 'chatMessage',
        content: content
      }));
      document.getElementById('chatInput').value = '';
    }

    // 语音录制
    function toggleVoiceRecord() {
      const btn = document.getElementById('voiceBtn');
      if (!mediaRecorder) {
        // 开始录制
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.start();
            btn.textContent = '松开停止';
            btn.style.background = '#dc3545';
          })
          .catch(err => console.error('录音权限被拒绝：', err));
      } else {
        // 停止录制
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const reader = new FileReader();
          reader.readAsDataURL(audioBlob);
          reader.onloadend = () => {
            const base64 = reader.result;
            ws.send(JSON.stringify({
              type: 'voiceMessage',
              content: base64
            }));
          };
          mediaRecorder = null;
          btn.textContent = '按住说话';
          btn.style.background = '#28a745';
        };
      }
    }

    // 添加聊天消息到页面
    function addChatMessage(content, type) {
      const messagesDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type === 'my' ? 'my-message' : type === 'other' ? 'other-message' : 'system-message'}`;
      msgDiv.textContent = content;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 添加语音消息到页面
    function addVoiceMessage(sender, time, voiceId) {
      const messagesDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'voice-message';
      msgDiv.innerHTML = `
        <span>${sender}（${time}）的语音消息：</span>
        <button onclick="playVoice(${voiceId})">播放</button>
      `;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 播放语音消息
    function playVoice(voiceId) {
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.src = voiceMessages[voiceId]; // 从全局voiceMessages获取
      audioPlayer.style.display = 'block';
      audioPlayer.play();
    }

    // 房主保存规则
    function saveRules() {
      const newRules = {
        maxPlayers: parseInt(document.getElementById('editMaxPlayers').value),
        daySpeakTime: parseInt(document.getElementById('editDaySpeakTime').value),
        lastWordTime: parseInt(document.getElementById('editLastWordTime').value),
        canWolfKillFirstNight: document.getElementById('editCanWolfKill').value === 'true'
      };
      ws.send(JSON.stringify({
        type: 'updateRules',
        newRules: newRules
      }));
    }

    // 开始游戏
    function startGame() {
      ws.send(JSON.stringify({ type: 'startGame' }));
    }

    // 离开房间
    function leaveRoom() {
      ws.close();
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>

