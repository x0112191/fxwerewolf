<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ€ - åŒ¹é…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/daisyui/4.12.10/full.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mobile-input {
            min-height: 44px;
            font-size: 16px;
        }
        .btn-mobile {
            min-height: 44px;
            min-width: 44px;
        }
        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        .player-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="flex justify-between items-center mb-12">
            <div class="flex items-center">
                <i class="fas fa-wolf-pack-battalion text-2xl mr-3 text-red-400"></i>
                <h1 class="text-2xl font-bold">ç‹¼äººæ€ - åŒ¹é…</h1>
            </div>
            <button onclick="logout()" class="btn btn-error btn-mobile">
                <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- åˆ›å»ºæˆ¿é—´ -->
            <div class="glass-effect rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-green-400"></i>åˆ›å»ºæˆ¿é—´
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">æ¸¸æˆæ¨¡å¼</label>
                        <select id="gameMode" class="w-full mobile-input bg-white/10 border border-white/20 rounded-lg px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="standard">æ ‡å‡†12äººå±€</option>
                            <option value="quick">å¿«é€Ÿ6äººå±€</option>
                            <option value="custom">è‡ªå®šä¹‰æ¨¡å¼</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">æˆ¿é—´è®¾ç½®</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked>
                                <span class="ml-2 text-sm">å…è®¸æ—è§‚è€…</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked>
                                <span class="ml-2 text-sm">å¼€å¯è¯­éŸ³èŠå¤©</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" id="needPassword">
                                <span class="ml-2 text-sm">éœ€è¦å¯†ç </span>
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="createRoom()" class="w-full btn btn-success btn-mobile py-6 text-lg">
                        <i class="fas fa-gamepad mr-2"></i>åˆ›å»ºæˆ¿é—´
                    </button>
                </div>
            </div>
            
            <!-- åŠ å…¥æˆ¿é—´ -->
            <div class="glass-effect rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-door-open mr-2 text-blue-400"></i>åŠ å…¥æˆ¿é—´
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="roomId" class="block text-sm font-medium mb-2">æˆ¿é—´å·</label>
                        <input type="text" id="roomId" placeholder="è¾“å…¥6ä½æˆ¿é—´å·" 
                            class="w-full mobile-input bg-white/10 border border-white/20 rounded-lg px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div id="passwordField" class="hidden">
                        <label for="roomPassword" class="block text-sm font-medium mb-2">æˆ¿é—´å¯†ç </label>
                        <input type="password" id="roomPassword" placeholder="è¾“å…¥æˆ¿é—´å¯†ç " 
                            class="w-full mobile-input bg-white/10 border border-white/20 rounded-lg px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button onclick="joinRoom()" class="w-full btn btn-primary btn-mobile py-6 text-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>åŠ å…¥æˆ¿é—´
                    </button>
                </div>
                
                <div class="mt-6 pt-6 border-t border-white/10">
                    <h3 class="text-lg font-medium mb-4">æ¨èæˆ¿é—´</h3>
                    <div id="recommendedRooms" class="space-y-3 max-h-40 overflow-y-auto">
                        <p class="text-sm text-gray-400 italic text-center">æš‚æ— æ¨èæˆ¿é—´</p>
                        <!-- æ¨èæˆ¿é—´ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆ¿é—´çŠ¶æ€é¢æ¿ï¼ˆåŠ å…¥/åˆ›å»ºæˆ¿é—´åæ˜¾ç¤ºï¼‰ -->
        <div id="roomPanel" class="glass-effect rounded-2xl p-6 mt-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-users mr-2 text-yellow-400"></i>æˆ¿é—´çŠ¶æ€
                    </h2>
                    <p class="text-sm text-gray-300 mt-1">æˆ¿é—´å·ï¼š<span id="currentRoomId"></span> | ç©å®¶ï¼š<span id="currentPlayerCount">0</span>/12</p>
                </div>
                <div id="roomOwnerInfo" class="hidden">
                    <span class="bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full text-sm">
                        æˆ¿ä¸»ï¼š<span id="roomOwnerName"></span>
                    </span>
                </div>
            </div>

            <!-- ç©å®¶åˆ—è¡¨ -->
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6" id="currentPlayerList">
                <!-- ç©å®¶å¡ç‰‡ä¼šåŠ¨æ€æ·»åŠ  -->
            </div>

            <!-- æˆ¿ä¸»è§’è‰²é…ç½®é¢æ¿ï¼ˆä»…æˆ¿ä¸»å¯è§ï¼Œ8äººåæ˜¾ç¤ºï¼‰ -->
            <div id="roleConfigPanel" class="hidden border-t border-white/10 pt-6 mt-6">
                <h3 class="text-lg font-bold mb-4">è§’è‰²é…ç½®ï¼ˆæˆ¿ä¸»å¯è°ƒæ•´ï¼‰</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                    <!-- ç‹¼äººé˜µè¥ -->
                    <div class="space-y-2">
                        <h4 class="text-sm font-medium text-red-400">ç‹¼äººé˜µè¥</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">æ™®é€šç‹¼äºº</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('normalWolf', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="normalWolfCount" value="2" min="1" max="5" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('normalWolf', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">ç™½ç‹¼ç‹</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('whiteWolf', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="whiteWolfCount" value="0" min="0" max="1" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('whiteWolf', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- å¥½äººé˜µè¥-ç¥èŒ -->
                    <div class="space-y-2">
                        <h4 class="text-sm font-medium text-blue-400">å¥½äººé˜µè¥ï¼ˆç¥èŒï¼‰</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">é¢„è¨€å®¶</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('seer', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="seerCount" value="1" min="0" max="2" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('seer', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">å¥³å·«</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('witch', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="witchCount" value="1" min="0" max="2" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('witch', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">çŒäºº</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('hunter', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="hunterCount" value="1" min="0" max="2" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('hunter', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">å®ˆå«</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('guard', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="guardCount" value="1" min="0" max="2" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('guard', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- å¥½äººé˜µè¥-å¹³æ°‘/ä¸­ç«‹ -->
                    <div class="space-y-2">
                        <h4 class="text-sm font-medium text-green-400">å¥½äººé˜µè¥ï¼ˆå¹³æ°‘ï¼‰</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">æ™®é€šå¹³æ°‘</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('civilian', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="civilianCount" value="3" min="0" max="8" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('civilian', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                        <h4 class="text-sm font-medium text-purple-400 mt-4">ä¸­ç«‹é˜µè¥</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">ç™½ç—´</span>
                            <div class="flex items-center">
                                <button onclick="adjustRoleCount('idiot', -1)" class="btn btn-xs btn-outline text-white">-</button>
                                <input type="number" id="idiotCount" value="0" min="0" max="1" class="w-12 text-center mobile-input bg-white/10 border border-white/20 rounded-lg text-white">
                                <button onclick="adjustRoleCount('idiot', 1)" class="btn btn-xs btn-outline text-white">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button onclick="confirmRoleConfig()" class="btn btn-success btn-mobile px-8">
                        <i class="fas fa-check mr-2"></i>ç¡®è®¤é…ç½®å¹¶å¼€å§‹æ¸¸æˆ
                    </button>
                </div>
            </div>

            <!-- éæˆ¿ä¸»ç­‰å¾…æç¤º -->
            <div id="waitForHostPanel" class="hidden text-center py-4 text-gray-300">
                <p>å·²è¾¾åˆ°8äººï¼Œç­‰å¾…æˆ¿ä¸»é…ç½®è§’è‰²å¹¶å¼€å§‹æ¸¸æˆ...</p>
            </div>

            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="border-t border-white/10 pt-6 mt-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-comments mr-2"></i>æˆ¿é—´èŠå¤©
                </h3>
                <div class="mb-4 h-32 overflow-y-auto bg-black/30 rounded-lg p-3" id="roomChatArea">
                    <!-- èŠå¤©æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ  -->
                </div>
                <div class="flex">
                    <input type="text" id="roomMessageInput" placeholder="è¾“å…¥èŠå¤©æ¶ˆæ¯..." 
                        class="flex-1 mobile-input bg-white/10 border border-white/20 rounded-l-lg px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="sendRoomMessage()" class="btn btn-primary rounded-l-none btn-mobile">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        const currentUser = JSON.parse(localStorage.getItem('current_user'));
        let ws = null;
        let roomState = {
            roomId: '',
            isHost: false,
            players: [],
            roleConfig: {}
        };

        // ğŸ”´ å¿…é¡»ä¿®æ”¹ï¼æ›¿æ¢æˆä½ çš„Renderé¡¹ç›®WebSocketåœ°å€ï¼ˆä¾‹ï¼šwss://werewolf-game-123.onrender.comï¼‰
        const RENDER_WS_URL = 'wss://ä½ çš„Renderé¡¹ç›®å.onrender.com';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!currentUser) {
            alert('è¯·å…ˆç™»å½•ï¼');
            window.location.href = 'index.html';
        }

        // å¯†ç é€‰é¡¹æ˜¾ç¤º/éšè—
        document.getElementById('needPassword').addEventListener('change', function() {
            document.getElementById('passwordField').classList.toggle('hidden', !this.checked);
        });

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('current_user');
            window.location.href = 'index.html';
        }

        // è¿æ¥WebSocketæœåŠ¡å™¨ï¼ˆRenderï¼‰
        function connectWebSocket() {
            // å…³é—­å·²æœ‰è¿æ¥
            if (ws) {
                ws.close();
            }

            // åˆ›å»ºæ–°è¿æ¥
            ws = new WebSocket(RENDER_WS_URL);

            // è¿æ¥æˆåŠŸ
            ws.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸï¼ˆRenderæœåŠ¡å™¨ï¼‰');
                addChatMessage('ç³»ç»Ÿ', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¯æ­£å¸¸æ¸¸æˆ', 'gray-400');
            };

            // æ¥æ”¶æ¶ˆæ¯
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:', data);

                switch(data.type) {
                    case 'roomCreated':
                        alert(`æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æˆ¿é—´å·ï¼š${data.roomId}`);
                        roomState.isHost = data.isHost;
                        updatePlayerList();
                        break;

                    case 'createFailed':
                        alert(`åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼š${data.reason}`);
                        break;

                    case 'joinedRoom':
                        alert('åŠ å…¥æˆ¿é—´æˆåŠŸï¼');
                        roomState.players = data.players;
                        roomState.isHost = data.players.some(p => p.id === currentUser.id && p.isHost);
                        updatePlayerList();
                        break;

                    case 'joinFailed':
                        alert(`åŠ å…¥æˆ¿é—´å¤±è´¥ï¼š${data.reason}`);
                        break;

                    case 'playerJoined':
                        roomState.players = data.players;
                        addChatMessage('ç³»ç»Ÿ', `${data.joinedPlayer.name} åŠ å…¥äº†æˆ¿é—´`, 'green-400');
                        updatePlayerList();
                        break;

                    case 'playerLeft':
                        roomState.players = data.players;
                        addChatMessage('ç³»ç»Ÿ', `ç©å®¶å·²ç¦»å¼€æˆ¿é—´`, 'red-400');
                        updatePlayerList();
                        break;

                    case 'hostElected':
                        roomState.players = data.players;
                        roomState.isHost = (data.hostId === currentUser.id);
                        addChatMessage('ç³»ç»Ÿ', `${data.hostName} æˆä¸ºæˆ¿ä¸»`, 'yellow-400');
                        updatePlayerList();
                        handle8PlayerLogic(); // é‡æ–°æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè§’è‰²é…ç½®
                        break;

                    case 'roleConfigSubmitted':
                        roomState.roleConfig = data.roleConfig;
                        addChatMessage('ç³»ç»Ÿ', 'æˆ¿ä¸»å·²æäº¤è§’è‰²é…ç½®ï¼Œå‡†å¤‡å¼€å§‹æ¸¸æˆ', 'blue-400');
                        break;

                    case 'gameStarted':
                        // ä¿å­˜è§’è‰²ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('playerRole', data.role);
                        localStorage.setItem('gameState', JSON.stringify(data.gameState));
                        localStorage.setItem('currentRoomId', roomState.roomId);
                        // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
                        window.location.href = 'game.html';
                        break;

                    case 'gameStartedBroadcast':
                        addChatMessage('ç³»ç»Ÿ', 'æ¸¸æˆå¼€å§‹ï¼æ­£åœ¨åˆ†é…è§’è‰²...', 'purple-400');
                        setTimeout(() => {
                            window.location.href = 'game.html';
                        }, 2000);
                        break;

                    case 'startFailed':
                        alert(`å¼€å§‹æ¸¸æˆå¤±è´¥ï¼š${data.reason}`);
                        break;

                    case 'newChatMessage':
                        addChatMessage(data.playerName, data.message, 'white');
                        break;

                    case 'error':
                        alert(`æœåŠ¡å™¨é”™è¯¯ï¼š${data.message}`);
                        break;
                }
            };

            // è¿æ¥å…³é—­
            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å…³é—­');
                addChatMessage('ç³»ç»Ÿ', 'ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡è¿...', 'red-400');
                // è‡ªåŠ¨é‡è¿
                setTimeout(connectWebSocket, 3000);
            };

            // è¿æ¥é”™è¯¯
            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                addChatMessage('ç³»ç»Ÿ', 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'red-400');
            };
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            const needPassword = document.getElementById('needPassword').checked;
            const password = needPassword ? document.getElementById('roomPassword').value.trim() : '';
            const gameMode = document.getElementById('gameMode').value;

            if (needPassword && !password) {
                alert('è¯·è¾“å…¥æˆ¿é—´å¯†ç ');
                return;
            }

            // ç”Ÿæˆ6ä½æˆ¿é—´å·
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            roomState.roomId = roomId;
            roomState.isHost = true;
            roomState.players = [{
                id: currentUser.id,
                name: currentUser.name,
                isHost: true
            }];

            // æ˜¾ç¤ºæˆ¿é—´é¢æ¿
            showRoomPanel();

            // è¿æ¥WebSocketæœåŠ¡å™¨ï¼ˆRenderï¼‰
            connectWebSocket();

            // å‘é€åˆ›å»ºæˆ¿é—´æ¶ˆæ¯
            sendWsMessage({
                type: 'createRoom',
                roomId: roomId,
                playerId: currentUser.id,
                playerName: currentUser.name,
                password: password,
                gameMode: gameMode
            });
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomId = document.getElementById('roomId').value.trim();
            const needPassword = document.getElementById('needPassword').checked;
            const password = needPassword ? document.getElementById('roomPassword').value.trim() : '';

            if (!roomId || roomId.length !== 6) {
                alert('è¯·è¾“å…¥6ä½æˆ¿é—´å·');
                return;
            }

            if (needPassword && !password) {
                alert('è¯·è¾“å…¥æˆ¿é—´å¯†ç ');
                return;
            }

            roomState.roomId = roomId;
            roomState.isHost = false;

            // æ˜¾ç¤ºæˆ¿é—´é¢æ¿
            showRoomPanel();

            // è¿æ¥WebSocketæœåŠ¡å™¨ï¼ˆRenderï¼‰
            connectWebSocket();

            // å‘é€åŠ å…¥æˆ¿é—´æ¶ˆæ¯
            sendWsMessage({
                type: 'joinRoom',
                roomId: roomId,
                playerId: currentUser.id,
                playerName: currentUser.name,
                password: password
            });
        }

        // æ˜¾ç¤ºæˆ¿é—´é¢æ¿
        function showRoomPanel() {
            document.getElementById('roomPanel').classList.remove('hidden');
            document.getElementById('currentRoomId').textContent = roomState.roomId;
            updatePlayerList();
        }

        // æ›´æ–°ç©å®¶åˆ—è¡¨
        function updatePlayerList() {
            const playerListEl = document.getElementById('currentPlayerList');
            const playerCountEl = document.getElementById('currentPlayerCount');
            const roomOwnerInfoEl = document.getElementById('roomOwnerInfo');
            const roomOwnerNameEl = document.getElementById('roomOwnerName');

            playerListEl.innerHTML = '';
            roomState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card text-center';
                playerCard.innerHTML = `
                    <div class="player-avatar mx-auto mb-2 flex items-center justify-center font-bold">
                        ${player.name.charAt(0)}
                    </div>
                    <p class="text-sm truncate">${player.name}</p>
                    ${player.isHost ? '<span class="text-xs bg-yellow-500/30 text-yellow-300 rounded-full px-2 py-0.5 mt-1 inline-block">æˆ¿ä¸»</span>' : ''}
                `;
                playerListEl.appendChild(playerCard);
            });

            playerCountEl.textContent = roomState.players.length;

            // æ˜¾ç¤ºæˆ¿ä¸»ä¿¡æ¯
            const host = roomState.players.find(player => player.isHost);
            if (host) {
                roomOwnerNameEl.textContent = host.name;
                roomOwnerInfoEl.classList.remove('hidden');
            } else {
                roomOwnerInfoEl.classList.add('hidden');
            }

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°8äººï¼Œè§¦å‘å¯¹åº”é€»è¾‘
            handle8PlayerLogic();
        }

        // 8äººæ—¶çš„é€»è¾‘ï¼ˆé€‰ä¸¾æˆ¿ä¸»+æ˜¾ç¤ºè§’è‰²é…ç½®ï¼‰
        function handle8PlayerLogic() {
            const playerCount = roomState.players.length;
            const hasHost = roomState.players.some(player => player.isHost);

            if (playerCount >= 8) {
                // æœ‰æˆ¿ä¸»ï¼šæˆ¿ä¸»æ˜¾ç¤ºè§’è‰²é…ç½®ï¼Œå…¶ä»–äººæ˜¾ç¤ºç­‰å¾…
                if (hasHost) {
                    if (roomState.isHost) {
                        document.getElementById('roleConfigPanel').classList.remove('hidden');
                        document.getElementById('waitForHostPanel').classList.add('hidden');
                    } else {
                        document.getElementById('roleConfigPanel').classList.add('hidden');
                        document.getElementById('waitForHostPanel').classList.remove('hidden');
                    }
                } else {
                    // æ— æˆ¿ä¸»ï¼šæç¤ºæ­£åœ¨é€‰ä¸¾
                    document.getElementById('waitForHostPanel').classList.remove('hidden');
                    document.getElementById('waitForHostPanel').innerHTML = '<p>å·²è¾¾åˆ°8äººï¼Œæ­£åœ¨é€‰ä¸¾æˆ¿ä¸»...</p>';
                }
            } else {
                // ä¸è¶³8äººï¼šéšè—ç›¸å…³é¢æ¿
                document.getElementById('roleConfigPanel').classList.add('hidden');
                document.getElementById('waitForHostPanel').classList.add('hidden');
            }
        }

        // è°ƒæ•´è§’è‰²æ•°é‡
        function adjustRoleCount(roleType, delta) {
            const inputEl = document.getElementById(`${roleType}Count`);
            let currentValue = parseInt(inputEl.value);
            const min = parseInt(inputEl.min);
            const max = parseInt(inputEl.max);

            currentValue += delta;
            currentValue = Math.max(min, Math.min(max, currentValue));
            inputEl.value = currentValue;

            // æ ¡éªŒæ€»è§’è‰²æ•°ç­‰äºç©å®¶æ•°
            validateTotalRoles();
        }

        // æ ¡éªŒæ€»è§’è‰²æ•°ç­‰äºç©å®¶æ•°
        function validateTotalRoles() {
            const totalRoles = 
                parseInt(document.getElementById('normalWolfCount').value) +
                parseInt(document.getElementById('whiteWolfCount').value) +
                parseInt(document.getElementById('seerCount').value) +
                parseInt(document.getElementById('witchCount').value) +
                parseInt(document.getElementById('hunterCount').value) +
                parseInt(document.getElementById('guardCount').value) +
                parseInt(document.getElementById('civilianCount').value) +
                parseInt(document.getElementById('idiotCount').value);

            const playerCount = roomState.players.length;
            return totalRoles === playerCount;
        }

        // ç¡®è®¤è§’è‰²é…ç½®å¹¶æäº¤
        function confirmRoleConfig() {
            if (!validateTotalRoles()) {
                alert(`è§’è‰²æ€»æ•°éœ€ç­‰äºç©å®¶æ•°ï¼ˆå½“å‰${roomState.players.length}äººï¼‰`);
                return;
            }

            // æ”¶é›†è§’è‰²é…ç½®
            const roleConfig = {
                normalWolf: parseInt(document.getElementById('normalWolfCount').value),
                whiteWolf: parseInt(document.getElementById('whiteWolfCount').value),
                seer: parseInt(document.getElementById('seerCount').value),
                witch: parseInt(document.getElementById('witchCount').value),
                hunter: parseInt(document.getElementById('hunterCount').value),
                guard: parseInt(document.getElementById('guardCount').value),
                civilian: parseInt(document.getElementById('civilianCount').value),
                idiot: parseInt(document.getElementById('idiotCount').value)
            };

            // ä¿å­˜è§’è‰²é…ç½®åˆ°æœ¬åœ°
            roomState.roleConfig = roleConfig;

            // å‘é€è§’è‰²é…ç½®åˆ°æœåŠ¡å™¨
            sendWsMessage({
                type: 'submitRoleConfig',
                roomId: roomState.roomId,
                playerId: currentUser.id,
                roleConfig: roleConfig
            });

            alert('è§’è‰²é…ç½®å·²æäº¤ï¼Œç‚¹å‡»"ç¡®è®¤"åå¼€å§‹æ¸¸æˆï¼');
            // å‘é€å¼€å§‹æ¸¸æˆè¯·æ±‚
            sendWsMessage({
                type: 'startGame',
                roomId: roomState.roomId,
                playerId: currentUser.id
            });
        }

        // å‘é€æˆ¿é—´èŠå¤©æ¶ˆæ¯
        function sendRoomMessage() {
            const messageInput = document.getElementById('roomMessageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            sendWsMessage({
                type: 'chatMessage',
                message: message
            });

            // æœ¬åœ°æ˜¾ç¤ºæ¶ˆæ¯
            addChatMessage(currentUser.name, message, 'white');

            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
        function addChatMessage(sender, content, colorClass) {
            const chatArea = document.getElementById('roomChatArea');
            const messageEl = document.createElement('div');
            messageEl.className = `flex items-start mb-2`;
            messageEl.innerHTML = `
                <span class="font-bold mr-2 text-${colorClass}">${sender}:</span>
                <span class="text-sm">${content}</span>
            `;
            chatArea.appendChild(messageEl);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // å‘é€WebSocketæ¶ˆæ¯
        function sendWsMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else {
                alert('æœåŠ¡å™¨è¿æ¥ä¸­ï¼Œè¯·ç¨åå†è¯•');
            }
        }

        // é¡µé¢å…³é—­æ—¶å‘é€ç¦»å¼€æˆ¿é—´æ¶ˆæ¯
        window.onbeforeunload = function() {
            if (ws && ws.readyState === WebSocket.OPEN && roomState.roomId) {
                sendWsMessage({
                    type: 'leaveRoom',
                    roomId: roomState.roomId,
                    playerId: currentUser.id
                });
            }
        };
    </script>
</body>
</html>