<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>狼人杀 - 游戏中</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', Arial, sans-serif;
    }
    body {
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e9ecef;
    }
    h1 {
      color: #333;
      font-size: 24px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .role-tag {
      background: #e6f7ff;
      color: #007bff;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 600;
    }
    .stage-tag {
      background: #fff3cd;
      color: #856404;
      padding: 5px 10px;
      border-radius: 4px;
    }
    /* 核心布局：左玩家列表+右聊天框 */
    .container {
      display: flex;
      gap: 30px;
      height: 650px;
    }
    .player-panel {
      width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-top: 3px solid #007bff;
      overflow-y: auto;
    }
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .chat-panel {
      flex: 1;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-top: 3px solid #17a2b8;
      display: flex;
      flex-direction: column;
    }
    .game-operate {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-top: 3px solid #28a745;
    }
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 10px;
    }
    /* 玩家列表（显示角色，自己可见） */
    .player-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
      border-left: 3px solid #007bff;
    }
    .player-item.self {
      background: #e6f7ff;
      border-left: 3px solid #dc3545;
      font-weight: 600;
    }
    .player-role {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
    .player-role.self-role {
      color: #dc3545;
      font-weight: 600;
    }
    /* 聊天框 */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }
    .message {
      margin: 8px 0;
      padding: 10px 12px;
      border-radius: 4px;
      max-width: 80%;
      line-height: 1.6;
      font-size: 14px;
    }
    .my-message {
      background: #e6f7ff;
      color: #007bff;
      margin-left: auto;
    }
    .other-message {
      background: #f1f3f5;
      color: #333;
      margin-right: auto;
    }
    .system-message {
      background: #fff3cd;
      color: #856404;
      margin: 10px auto;
      max-width: 60%;
      text-align: center;
    }
    .voice-message {
      background: #f0f8fb;
      color: #17a2b8;
      padding: 10px;
      border-radius: 4px;
      max-width: 80%;
      margin-right: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-input {
      display: flex;
      gap: 10px;
    }
    #chatInput {
      flex: 1;
      padding: 12px 15px;
      background: #f8f9fa;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      color: #333;
    }
    .chat-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .send-btn {
      background: #007bff;
      color: white;
    }
    .voice-btn {
      background: #17a2b8;
      color: white;
    }
    /* 游戏操作面板（轮流发言+警长竞选） */
    .operate-btn-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    .operate-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .speak-btn {
      background: #ffc107;
      color: #333;
    }
    .campaign-btn {
      background: #dc3545;
      color: white;
    }
    .withdraw-btn {
      background: #6c757d;
      color: white;
      display: none; /* 退水按钮默认隐藏 */
    }
    /* 发牌动画样式 */
    .card-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 280px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
      animation: cardFlip 1.5s ease-in-out;
    }
    @keyframes cardFlip {
      0% { transform: translate(-50%, -50%) rotateY(0deg); opacity: 0; }
      50% { transform: translate(-50%, -50%) rotateY(180deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotateY(360deg); opacity: 0; }
    }
    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .card-role {
      font-size: 24px;
      color: #dc3545;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- 发牌动画（进入页面时显示） -->
  <div class="card-animation" id="cardAnimation">
    <div class="card-title">你的角色是</div>
    <div class="card-role" id="cardRole"></div>
  </div>

  <div class="header">
    <h1>房间号：<span id="roomId"></span></h1>
    <div class="header-right">
      <span class="role-tag">你的角色：<span id="yourRole"></span></span>
      <span class="stage-tag" id="gameStage">白天阶段 - 等待发言</span>
    </div>
  </div>

  <div class="container">
    <!-- 左：玩家列表 -->
    <div class="player-panel">
      <div class="panel-title">玩家列表（当前发言：<span id="currentSpeaker">无</span>）</div>
      <div id="playerList"></div>
    </div>

    <!-- 右：聊天框+游戏操作 -->
    <div class="right-panel">
      <div class="chat-panel">
        <div class="panel-title">聊天区域</div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="输入聊天内容..." />
          <button class="chat-btn send-btn" onclick="sendChat()">发送</button>
          <button class="chat-btn voice-btn" id="voiceBtn" onclick="toggleVoiceRecord()">按住说话</button>
        </div>
        <audio id="audioPlayer" controls></audio>
      </div>

      <div class="game-operate">
        <div class="panel-title">游戏操作</div>
        <div id="campaignTip" style="color:#666; margin-bottom:10px;">警长竞选：可点击「竞选警长」参与入水</div>
        <div class="operate-btn-group">
          <button class="operate-btn speak-btn" id="speakBtn" disabled>未轮到你发言</button>
          <button class="operate-btn campaign-btn" id="campaignBtn" onclick="campaignSheriff()">竞选警长（入水）</button>
          <button class="operate-btn withdraw-btn" id="withdrawBtn" onclick="withdrawSheriff()">退水</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 获取URL参数
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('roomId');
    const username = params.get('username');
    const role = params.get('role');
    const isHost = params.get('isHost') === 'true';

    // 初始化页面
    document.getElementById('roomId').textContent = roomId;
    document.getElementById('yourRole').textContent = role;
    document.getElementById('cardRole').textContent = role;

    // 全局变量
    let ws = new WebSocket('wss://你的服务器IP:3000');
    let mediaRecorder = null;
    let audioChunks = [];
    let isNight = false;
    let isCampaign = false; // 是否参与警长竞选
    let voiceRemain = 3;
    window.voiceMessages = {};

    // 发牌动画结束后隐藏
    setTimeout(() => {
      document.getElementById('cardAnimation').style.display = 'none';
    }, 1500);

    // WebSocket连接
    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: 'enterGame',
        roomId,
        username,
        role
      }));
    };

    // 接收消息
    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      handleMessage(data);
    };

    // 处理消息
    function handleMessage(data) {
      switch (data.type) {
        case 'playerList':
          data.players.forEach(player => {
            addPlayerItem(player.username, player.isSelf, player.role);
          });
          break;
        case 'chatBroadcast':
          const isMyMsg = data.username === username;
          addChatMessage(`${data.username}（${data.time}）：${data.content}`, isMyMsg ? 'my' : 'other');
          break;
        case 'voiceBroadcast':
          window.voiceMessages[data.voiceId] = data.content;
          addVoiceMessage(data.username, data.time, data.voiceId);
          break;
        case 'speakTurn':
          document.getElementById('currentSpeaker').textContent = data.username;
          document.getElementById('gameStage').textContent = `白天阶段 - ${data.username}发言中`;
          if (data.username === username) {
            document.getElementById('speakBtn').disabled = false;
            document.getElementById('speakBtn').textContent = '开始发言（畅所欲言）';
          } else {
            document.getElementById('speakBtn').disabled = true;
            document.getElementById('speakBtn').textContent = `等待${data.username}发言`;
          }
          break;
        case 'nightMode':
          isNight = true;
          document.getElementById('gameStage').textContent = '夜间阶段 - 文字≤10字';
          document.getElementById('currentSpeaker').textContent = '无';
          document.getElementById('speakBtn').disabled = true;
          document.getElementById('speakBtn').textContent = '夜间不可发言';
          break;
        case 'dayMode':
          isNight = false;
          voiceRemain = 3;
          document.getElementById('gameStage').textContent = '白天阶段 - 等待发言';
          break;
        case 'sheriffCampaign':
          document.getElementById('campaignTip').textContent = `警长竞选：${data.campaigners.join('、')}已入水，未竞选者可讨论`;
          break;
        case 'sheriffWithdraw':
          document.getElementById('campaignTip').textContent = `警长竞选：${data.username}已退水，剩余入水者：${data.remain.join('、')}`;
          if (data.username === username) {
            isCampaign = false;
            document.getElementById('campaignBtn').style.display = 'block';
            document.getElementById('withdrawBtn').style.display = 'none';
          }
          break;
        case 'sheriffResult':
          addChatMessage(`【系统通知】警长竞选结果：${data.sheriff}当选警长！`, 'system');
          break;
      }
    }

    // 添加玩家项
    function addPlayerItem(username, isSelf, role) {
      const list = document.getElementById('playerList');
      const item = document.createElement('div');
      item.className = `player-item ${isSelf ? 'self' : ''}`;
      item.innerHTML = `
        <div>${username}</div>
        <div class="player-role ${isSelf ? 'self-role' : ''}">
          ${isSelf ? `角色：${role}` : '角色：未知'}
        </div>
      `;
      list.appendChild(item);
    }

    // 发送聊天
    function sendChat() {
      const content = document.getElementById('chatInput').value.trim();
      if (!content) return;
      if (isNight && content.length > 10) {
        alert('夜间消息≤10字！');
        return;
      }
      ws.send(JSON.stringify({
        type: 'chatMessage',
        content,
        username
      }));
      document.getElementById('chatInput').value = '';
    }

    // 语音录制
    function toggleVoiceRecord() {
      if (isNight) {
        alert('夜间不支持语音！');
        return;
      }
      if (voiceRemain <= 0) {
        alert('语音条数已用完！');
        return;
      }
      const btn = document.getElementById('voiceBtn');
      if (!mediaRecorder) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.start();
            btn.textContent = '松开停止（≤2秒）';
            btn.style.background = '#dc3545';
            setTimeout(() => {
              if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                mediaRecorder = null;
                btn.textContent = '按住说话';
                btn.style.background = '#17a2b8';
              }
            }, 2000);
          })
          .catch(err => alert('录音权限被拒绝！'));
      } else {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const reader = new FileReader();
          reader.readAsDataURL(audioBlob);
          reader.onloadend = () => {
            ws.send(JSON.stringify({
              type: 'voiceMessage',
              content: reader.result,
              username
            }));
            voiceRemain--;
          };
          mediaRecorder = null;
          btn.textContent = '按住说话';
          btn.style.background = '#17a2b8';
        };
      }
    }

    // 竞选警长（入水）
    function campaignSheriff() {
      isCampaign = true;
      document.getElementById('campaignBtn').style.display = 'none';
      document.getElementById('withdrawBtn').style.display = 'block';
      ws.send(JSON.stringify({
        type: 'campaignSheriff',
        username,
        roomId
      }));
    }

    // 退水
    function withdrawSheriff() {
      ws.send(JSON.stringify({
        type: 'withdrawSheriff',
        username,
        roomId
      }));
    }

    // 添加聊天/语音消息（复用match.html逻辑）
    function addChatMessage(content, type) {
      const messagesDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type === 'my' ? 'my-message' : type === 'other' ? 'other-message' : 'system-message'}`;
      msgDiv.textContent = content;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addVoiceMessage(sender, time, voiceId) {
      const messagesDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'voice-message';
      msgDiv.innerHTML = `
        <span>${sender}（${time}）的语音消息：</span>
        <button class="chat-btn voice-btn" style="padding:4px 8px; font-size:12px;" onclick="playVoice('${voiceId}')">播放</button>
      `;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function playVoice(voiceId) {
      const audioPlayer = document.getElementById('audioPlayer');
      audioPlayer.src = window.voiceMessages[voiceId];
      audioPlayer.style.display = 'block';
      audioPlayer.play();
    }
  </script>
</body>
</html>
