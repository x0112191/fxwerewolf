<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ€ - æ¸¸æˆæˆ¿é—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/daisyui/4.12.10/full.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mobile-input {
            min-height: 44px;
            font-size: 16px;
        }
        .btn-mobile {
            min-height: 44px;
            min-width: 44px;
        }
        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        .player-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        .player-card.alive {
            border-color: rgba(46, 204, 113, 0.5);
        }
        .player-card.dead {
            border-color: rgba(231, 76, 60, 0.5);
            opacity: 0.7;
        }
        .role-card {
            background: linear-gradient(45deg, #1a2a3a, #2c3e50);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <i class="fas fa-wolf-pack-battalion text-2xl mr-3 text-red-400"></i>
                <h1 class="text-2xl font-bold">ç‹¼äººæ€æ¸¸æˆ</h1>
                <span class="ml-4 bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full text-sm">
                    æˆ¿é—´å·ï¼š<span id="gameRoomId"></span>
                </span>
            </div>
            <div class="flex space-x-4">
                <button onclick="showRules()" class="btn btn-primary btn-mobile">
                    <i class="fas fa-book mr-2"></i>è§„åˆ™
                </button>
                <button onclick="exitGame()" class="btn btn-error btn-mobile">
                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡º
                </button>
            </div>
        </header>

        <!-- æ¸¸æˆçŠ¶æ€ -->
        <div class="glass-effect rounded-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" id="gameStatus">æ¸¸æˆè¿›è¡Œä¸­ - å¤œæ™šé˜¶æ®µ</h2>
                <div class="text-sm text-gray-300">
                    å­˜æ´»ç©å®¶ï¼š<span id="alivePlayerCount">0</span>/<span id="totalPlayerCount">0</span>
                </div>
            </div>
            
            <!-- ç©å®¶åˆ—è¡¨ -->
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3" id="playerList">
                <!-- ç©å®¶å¡ç‰‡ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šæ¸¸æˆä¿¡æ¯ -->
            <div class="lg:col-span-2 space-y-6">
                <!-- æ¸¸æˆæ—¥å¿— -->
                <div class="glass-effect rounded-2xl p-6 h-64 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-2"></i>æ¸¸æˆæ—¥å¿—
                    </h3>
                    <div id="gameLog" class="space-y-2 text-sm">
                        <p class="text-gray-400">æ¸¸æˆå¼€å§‹ï¼Œè§’è‰²åˆ†é…å®Œæˆ...</p>
                    </div>
                </div>

                <!-- å‘è¨€åŒº -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-comments mr-2"></i>å‘è¨€åŒº
                    </h3>
                    <div class="mb-4 h-40 overflow-y-auto bg-black/30 rounded-lg p-3" id="chatArea">
                        <!-- èŠå¤©æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                    <div class="flex">
                        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." 
                            class="flex-1 mobile-input bg-white/10 border border-white/20 rounded-l-lg px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="sendMessage()" class="btn btn-primary rounded-l-none btn-mobile">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ“ä½œåŒº -->
            <div class="space-y-6">
                <!-- è§’è‰²ä¿¡æ¯ -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-user-secret mr-2"></i>ä½ çš„è§’è‰²
                    </h3>
                    <div id="roleInfo" class="role-card text-center py-6">
                        <i class="fas fa-user-secret text-4xl mb-3" id="roleIcon"></i>
                        <h4 class="text-xl font-bold mb-2" id="roleName">åŠ è½½ä¸­...</h4>
                        <p class="text-sm text-gray-300" id="roleDescription">åŠ è½½è§’è‰²æè¿°...</p>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2"></i>æ¸¸æˆæ“ä½œ
                    </h3>
                    <div class="grid grid-cols-2 gap-3" id="actionButtons">
                        <button id="voteButton" onclick="showVotePanel()" class="btn btn-primary btn-mobile">
                            <i class="fas fa-vote-yea mr-2"></i>æŠ•ç¥¨
                        </button>
                        <button id="skillButton" onclick="useSkill()" class="btn btn-info btn-mobile">
                            <i class="fas fa-magic mr-2"></i>æŠ€èƒ½
                        </button>
                        <button id="skipButton" onclick="skipTurn()" class="btn btn-warning btn-mobile">
                            <i class="fas fa-forward mr-2"></i>è·³è¿‡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ•ç¥¨é¢æ¿ -->
    <dialog id="voteModal" class="glass-effect rounded-2xl p-6 max-w-md text-white border-none">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">æŠ•ç¥¨æ·˜æ±°</h3>
            <button onclick="closeVoteModal()" class="text-gray-300 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="space-y-4 max-h-60 overflow-y-auto" id="votePlayerList">
            <!-- æŠ•ç¥¨ç©å®¶åˆ—è¡¨ -->
        </div>
        <div class="modal-action mt-4">
            <button onclick="closeVoteModal()" class="btn btn-outline">å–æ¶ˆ</button>
        </div>
    </dialog>

    <!-- è§„åˆ™å¼¹çª— -->
    <dialog id="rulesModal" class="glass-effect rounded-2xl p-6 max-w-2xl text-white border-none">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">æ¸¸æˆè§„åˆ™</h3>
            <button onclick="closeRules()" class="text-gray-300 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="space-y-6 max-h-[70vh] overflow-y-auto">
            <div>
                <h4 class="font-bold text-lg mb-3">æ¸¸æˆæµç¨‹</h4>
                <ol class="text-sm text-gray-300 space-y-1">
                    <li>1. å¤œæ™šé˜¶æ®µï¼šç‹¼äººæ€äººï¼Œç¥èŒä½¿ç”¨æŠ€èƒ½ï¼Œä¸­ç«‹è§’è‰²è¡ŒåŠ¨</li>
                    <li>2. ç™½å¤©é˜¶æ®µï¼šè®¨è®ºå‘è¨€ï¼ŒæŠ•ç¥¨æ·˜æ±°ï¼Œè­¦é•¿ç«é€‰</li>
                    <li>3. èƒœè´Ÿåˆ¤å®šï¼šæŸä¸€é˜µè¥è¾¾æˆèƒœåˆ©æ¡ä»¶å³æ¸¸æˆç»“æŸ</li>
                </ol>
            </div>
            <div>
                <h4 class="font-bold text-lg mb-3">è§’è‰²æŠ€èƒ½</h4>
                <div class="space-y-3 text-sm text-gray-300">
                    <div>
                        <strong class="text-red-400">æ™®é€šç‹¼äºº</strong>ï¼šå¤œæ™šå¯ä»¥å…±åŒå‡»æ€ä¸€åç©å®¶
                    </div>
                    <div>
                        <strong class="text-red-400">ç™½ç‹¼ç‹</strong>ï¼šå¤œæ™šå¯ä»¥å‡»æ€ä¸€åç©å®¶ï¼Œç™½å¤©å¯ä»¥è‡ªçˆ†å¸¦èµ°ä¸€åç©å®¶
                    </div>
                    <div>
                        <strong class="text-blue-400">é¢„è¨€å®¶</strong>ï¼šå¤œæ™šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶çš„é˜µè¥
                    </div>
                    <div>
                        <strong class="text-blue-400">å¥³å·«</strong>ï¼šæ‹¥æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯ï¼Œå¤œæ™šå¯ä»¥æ•‘äººæˆ–æ¯’äºº
                    </div>
                    <div>
                        <strong class="text-blue-400">çŒäºº</strong>ï¼šè¢«æ·˜æ±°æ—¶å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶
                    </div>
                    <div>
                        <strong class="text-blue-400">å®ˆå«</strong>ï¼šå¤œæ™šå¯ä»¥å®ˆæŠ¤ä¸€åç©å®¶ï¼Œé˜²æ­¢è¢«ç‹¼äººå‡»æ€
                    </div>
                    <div>
                        <strong class="text-green-400">æ™®é€šå¹³æ°‘</strong>ï¼šæ— ç‰¹æ®ŠæŠ€èƒ½ï¼Œç™½å¤©å‚ä¸æŠ•ç¥¨
                    </div>
                    <div>
                        <strong class="text-purple-400">ç™½ç—´</strong>ï¼šè¢«æŠ•ç¥¨æ·˜æ±°æ—¶ä¸ä¼šå‡ºå±€ï¼Œå¤±å»æŠ•ç¥¨æƒä½†å¯ä»¥å‘è¨€
                    </div>
                </div>
            </div>
            <div>
                <h4 class="font-bold text-lg mb-3">èƒœåˆ©æ¡ä»¶</h4>
                <ul class="text-sm text-gray-300 space-y-1">
                    <li>â€¢ ç‹¼äººé˜µè¥ï¼šå‡»æ€æ‰€æœ‰å¥½äººé˜µè¥ç©å®¶</li>
                    <li>â€¢ å¥½äººé˜µè¥ï¼šæ”¾é€æ‰€æœ‰ç‹¼äººé˜µè¥ç©å®¶</li>
                    <li>â€¢ ä¸­ç«‹é˜µè¥ï¼šå®Œæˆå„è‡ªç‹¬ç‰¹çš„èƒœåˆ©æ¡ä»¶</li>
                </ul>
            </div>
        </div>
    </dialog>

    <script>
        // å…¨å±€çŠ¶æ€
        const currentUser = JSON.parse(localStorage.getItem('current_user'));
        const playerRole = localStorage.getItem('playerRole');
        const gameState = JSON.parse(localStorage.getItem('gameState'));
        const currentRoomId = localStorage.getItem('currentRoomId');
        let ws = null;
        let players = [];

        // ğŸ”´ å¿…é¡»ä¿®æ”¹ï¼æ›¿æ¢æˆä½ çš„Renderé¡¹ç›®WebSocketåœ°å€ï¼ˆå’Œmatch.htmlé‡Œçš„ä¸€è‡´ï¼‰
        const RENDER_WS_URL = 'wss://ä½ çš„Renderé¡¹ç›®å.onrender.com';

        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
        if (!currentUser || !playerRole || !gameState || !currentRoomId) {
            alert('æ¸¸æˆçŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°è¿›å…¥æˆ¿é—´ï¼');
            window.location.href = 'match.html';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            // æ˜¾ç¤ºæˆ¿é—´å·
            document.getElementById('gameRoomId').textContent = currentRoomId;
            // æ˜¾ç¤ºè§’è‰²ä¿¡æ¯
            showRoleInfo();
            // è¿æ¥WebSocketæœåŠ¡å™¨
            connectWebSocket();
            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            updateGameStatus();
        };

        // è¿æ¥WebSocketæœåŠ¡å™¨ï¼ˆRenderï¼‰
        function connectWebSocket() {
            // å…³é—­å·²æœ‰è¿æ¥
            if (ws) {
                ws.close();
            }

            // åˆ›å»ºæ–°è¿æ¥
            ws = new WebSocket(RENDER_WS_URL);

            // è¿æ¥æˆåŠŸ
            ws.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸï¼ˆæ¸¸æˆé¡µé¢ï¼‰');
                addGameLog('ç³»ç»Ÿ', 'å·²è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨');
            };

            // æ¥æ”¶æ¶ˆæ¯
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°æ¸¸æˆæ¶ˆæ¯:', data);

                switch(data.type) {
                    case 'playerListUpdate':
                        players = data.players;
                        updatePlayerList();
                        updateGameStatus();
                        break;

                    case 'gameAction':
                        handleGameAction(data.action, data.playerId);
                        break;

                    case 'newChatMessage':
                        addChatMessage(data.playerName, data.message);
                        break;

                    case 'phaseChange':
                        gameState.phase = data.phase;
                        updateGameStatus();
                        addGameLog('ç³»ç»Ÿ', `æ¸¸æˆé˜¶æ®µåˆ‡æ¢ä¸ºï¼š${getPhaseName(data.phase)}`);
                        break;

                    case 'playerKilled':
                        const killedPlayer = players.find(p => p.id === data.playerId);
                        if (killedPlayer) {
                            killedPlayer.isAlive = false;
                            updatePlayerList();
                            addGameLog('ç³»ç»Ÿ', `${killedPlayer.name} è¢«æ·˜æ±°äº†`);
                        }
                        break;

                    case 'error':
                        alert(`æ¸¸æˆé”™è¯¯ï¼š${data.message}`);
                        break;
                }
            };

            // è¿æ¥å…³é—­
            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å…³é—­');
                addGameLog('ç³»ç»Ÿ', 'ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡è¿...', 'red-400');
                // è‡ªåŠ¨é‡è¿
                setTimeout(connectWebSocket, 3000);
            };

            // è¿æ¥é”™è¯¯
            ws.onerror = function(error) {
                console.error('æ¸¸æˆWebSocketé”™è¯¯:', error);
                addGameLog('ç³»ç»Ÿ', 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'red-400');
            };
        }

        // æ˜¾ç¤ºè§’è‰²ä¿¡æ¯
        function showRoleInfo() {
            const roleNameEl = document.getElementById('roleName');
            const roleDescEl = document.getElementById('roleDescription');
            const roleIconEl = document.getElementById('roleIcon');

            roleNameEl.textContent = playerRole;

            // è®¾ç½®è§’è‰²å›¾æ ‡å’Œæè¿°
            switch(playerRole) {
                case 'æ™®é€šç‹¼äºº':
                    roleIconEl.className = 'fas fa-user-secret text-4xl mb-3 text-red-500';
                    roleDescEl.textContent = 'å¤œæ™šå¯ä»¥å’Œå…¶ä»–ç‹¼äººä¸€èµ·å‡»æ€ä¸€åç©å®¶ï¼Œç™½å¤©éšè—èº«ä»½è¯¯å¯¼ä»–äºº';
                    break;
                case 'ç™½ç‹¼ç‹':
                    roleIconEl.className = 'fas fa-crown text-4xl mb-3 text-red-600';
                    roleDescEl.textContent = 'ç‹¼äººé˜µè¥é¢†è¢–ï¼Œå¤œæ™šå¯ä»¥å‡»æ€ç©å®¶ï¼Œç™½å¤©å¯ä»¥è‡ªçˆ†å¸¦èµ°ä¸€åç©å®¶';
                    break;
                case 'é¢„è¨€å®¶':
                    roleIconEl.className = 'fas fa-eye text-4xl mb-3 text-blue-500';
                    roleDescEl.textContent = 'å¥½äººé˜µè¥ç¥èŒï¼Œå¤œæ™šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶çš„é˜µè¥èº«ä»½';
                    break;
                case 'å¥³å·«':
                    roleIconEl.className = 'fas fa-potion text-4xl mb-3 text-green-500';
                    roleDescEl.textContent = 'å¥½äººé˜µè¥ç¥èŒï¼Œæ‹¥æœ‰è§£è¯å’Œæ¯’è¯ï¼Œå¤œæ™šå¯ä»¥æ•‘äººæˆ–æ¯’æ€ä¸€åç©å®¶';
                    break;
                case 'çŒäºº':
                    roleIconEl.className = 'fas fa-crosshairs text-4xl mb-3 text-orange-500';
                    roleDescEl.textContent = 'å¥½äººé˜µè¥ç¥èŒï¼Œè¢«æ·˜æ±°æ—¶å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶';
                    break;
                case 'å®ˆå«':
                    roleIconEl.className = 'fas fa-shield-alt text-4xl mb-3 text-purple-500';
                    roleDescEl.textContent = 'å¥½äººé˜µè¥ç¥èŒï¼Œå¤œæ™šå¯ä»¥å®ˆæŠ¤ä¸€åç©å®¶ï¼Œé˜²æ­¢è¢«ç‹¼äººå‡»æ€';
                    break;
                case 'æ™®é€šå¹³æ°‘':
                    roleIconEl.className = 'fas fa-user text-4xl mb-3 text-gray-300';
                    roleDescEl.textContent = 'å¥½äººé˜µè¥ï¼Œæ— ç‰¹æ®ŠæŠ€èƒ½ï¼Œç™½å¤©é€šè¿‡åˆ†ææ¨ç†æ‰¾å‡ºç‹¼äºº';
                    break;
                case 'ç™½ç—´':
                    roleIconEl.className = 'fas fa-question-circle text-4xl mb-3 text-yellow-500';
                    roleDescEl.textContent = 'ä¸­ç«‹é˜µè¥ï¼Œè¢«æŠ•ç¥¨æ·˜æ±°æ—¶ä¸ä¼šå‡ºå±€ï¼Œå¤±å»æŠ•ç¥¨æƒä½†å¯ä»¥ç»§ç»­å‘è¨€';
                    break;
                default:
                    roleIconEl.className = 'fas fa-user-secret text-4xl mb-3';
                    roleDescEl.textContent = 'æœªçŸ¥è§’è‰²';
            }
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGameStatus() {
            const gameStatusEl = document.getElementById('gameStatus');
            const aliveCountEl = document.getElementById('alivePlayerCount');
            const totalCountEl = document.getElementById('totalPlayerCount');

            // æ›´æ–°æ¸¸æˆé˜¶æ®µæ–‡æœ¬
            gameStatusEl.textContent = `æ¸¸æˆè¿›è¡Œä¸­ - ${getPhaseName(gameState.phase)}`;

            // æ›´æ–°ç©å®¶æ•°é‡
            totalCountEl.textContent = players.length;
            const aliveCount = players.filter(p => p.isAlive !== false).length;
            aliveCountEl.textContent = aliveCount;

            // æ›´æ–°ç©å®¶åˆ—è¡¨
            updatePlayerList();

            // æ›´æ–°æ“ä½œæŒ‰é’®çŠ¶æ€
            updateActionButtons();
        }

        // è·å–é˜¶æ®µåç§°
        function getPhaseName(phase) {
            switch(phase) {
                case 'waiting': return 'ç­‰å¾…é˜¶æ®µ';
                case 'night': return 'å¤œæ™šé˜¶æ®µ';
                case 'day': return 'ç™½å¤©é˜¶æ®µ';
                case 'voting': return 'æŠ•ç¥¨é˜¶æ®µ';
                case 'over': return 'æ¸¸æˆç»“æŸ';
                default: return 'æœªçŸ¥é˜¶æ®µ';
            }
        }

        // æ›´æ–°ç©å®¶åˆ—è¡¨
        function updatePlayerList() {
            const playerListEl = document.getElementById('playerList');
            const votePlayerListEl = document.getElementById('votePlayerList');

            playerListEl.innerHTML = '';
            votePlayerListEl.innerHTML = '';

            if (players.length === 0) {
                playerListEl.innerHTML = '<p class="text-center text-gray-400 col-span-full">æš‚æ— ç©å®¶</p>';
                return;
            }

            players.forEach(player => {
                const isAlive = player.isAlive !== false;
                const isCurrentUser = player.id === currentUser.id;

                // æ¸¸æˆé¡µé¢ç©å®¶å¡ç‰‡
                const playerCard = document.createElement('div');
                playerCard.className = `player-card text-center ${isAlive ? 'alive' : 'dead'}`;
                playerCard.innerHTML = `
                    <div class="player-avatar mx-auto mb-2 flex items-center justify-center font-bold" style="background: ${isCurrentUser ? 'linear-gradient(45deg, #e74c3c, #c0392b)' : 'linear-gradient(45deg, #3498db, #2980b9)'}"">
                        ${player.name.charAt(0)}
                    </div>
                    <p class="text-sm truncate">${player.name}</p>
                    ${isCurrentUser ? '<span class="text-xs bg-red-500/30 text-red-300 rounded-full px-2 py-0.5 mt-1 inline-block">ä½ </span>' : ''}
                    ${!isAlive ? '<span class="text-xs bg-red-500/30 text-red-300 rounded-full px-2 py-0.5 mt-1 inline-block">å·²æ·˜æ±°</span>' : ''}
                `;
                playerListEl.appendChild(playerCard);

                // æŠ•ç¥¨é¢æ¿ç©å®¶å¡ç‰‡ï¼ˆåªæ˜¾ç¤ºå­˜æ´»ä¸”ä¸æ˜¯è‡ªå·±çš„ç©å®¶ï¼‰
                if (isAlive && !isCurrentUser) {
                    const voteCard = document.createElement('div');
                    voteCard.className = 'player-card text-center cursor-pointer hover:bg-white/10';
                    voteCard.innerHTML = `
                        <div class="player-avatar mx-auto mb-2 flex items-center justify-center font-bold">
                            ${player.name.charAt(0)}
                        </div>
                        <p class="text-sm truncate">${player.name}</p>
                    `;
                    voteCard.onclick = function() {
                        votePlayer(player.id, player.name);
                    };
                    votePlayerListEl.appendChild(voteCard);
                }
            });
        }

        // æ›´æ–°æ“ä½œæŒ‰é’®
        function updateActionButtons() {
            const voteBtn = document.getElementById('voteButton');
            const skillBtn = document.getElementById('skillButton');
            const skipBtn = document.getElementById('skipButton');

            // æ ¹æ®æ¸¸æˆé˜¶æ®µå’Œè§’è‰²æ˜¾ç¤ºæŒ‰é’®
            switch(gameState.phase) {
                case 'night':
                    // å¤œæ™šé˜¶æ®µï¼šç‹¼äººæ˜¾ç¤ºæ€äººæŒ‰é’®ï¼Œç¥èŒæ˜¾ç¤ºæŠ€èƒ½æŒ‰é’®
                    voteBtn.classList.add('hidden');
                    skipBtn.classList.remove('hidden');
                    if (playerRole.includes('ç‹¼äºº')) {
                        skillBtn.textContent = 'å‡»æ€ç©å®¶';
                        skillBtn.classList.remove('hidden');
                    } else if (['é¢„è¨€å®¶', 'å¥³å·«', 'å®ˆå«'].includes(playerRole)) {
                        skillBtn.textContent = 'ä½¿ç”¨æŠ€èƒ½';
                        skillBtn.classList.remove('hidden');
                    } else {
                        skillBtn.classList.add('hidden');
                    }
                    break;
                case 'day':
                    // ç™½å¤©é˜¶æ®µï¼šæ˜¾ç¤ºæŠ•ç¥¨æŒ‰é’®
                    voteBtn.classList.remove('hidden');
                    skillBtn.classList.add('hidden');
                    skipBtn.classList.remove('hidden');
                    break;
                case 'voting':
                    // æŠ•ç¥¨é˜¶æ®µï¼šæ˜¾ç¤ºæŠ•ç¥¨æŒ‰é’®
                    voteBtn.classList.remove('hidden');
                    skillBtn.classList.add('hidden');
                    skipBtn.classList.remove('hidden');
                    break;
                default:
                    voteBtn.classList.add('hidden');
                    skillBtn.classList.add('hidden');
                    skipBtn.classList.add('hidden');
            }
        }

        // æ˜¾ç¤ºæŠ•ç¥¨é¢æ¿
        function showVotePanel() {
            document.getElementById('voteModal').showModal();
        }

        // å…³é—­æŠ•ç¥¨é¢æ¿
        function closeVoteModal() {
            document.getElementById('voteModal').close();
        }

        // æŠ•ç¥¨ç©å®¶
        function votePlayer(playerId, playerName) {
            const actionType = gameState.phase === 'night' && playerRole.includes('ç‹¼äºº') ? 'kill' : 'vote';
            const actionText = actionType === 'kill' ? 'å‡»æ€' : 'æŠ•ç¥¨æ·˜æ±°';

            if (confirm(`ç¡®å®šè¦${actionText} ${playerName}å—ï¼Ÿ`)) {
                // å‘é€æŠ•ç¥¨/å‡»æ€æ¶ˆæ¯
                sendWsMessage({
                    type: 'gameAction',
                    action: actionType,
                    targetPlayerId: playerId,
                    roomId: currentRoomId,
                    playerId: currentUser.id
                });

                addGameLog('ç³»ç»Ÿ', `ä½ å·²é€‰æ‹©${actionText} ${playerName}`);
                closeVoteModal();
            }
        }

        // ä½¿ç”¨æŠ€èƒ½
        function useSkill() {
            switch(playerRole) {
                case 'é¢„è¨€å®¶':
                    alert('é¢„è¨€å®¶æŠ€èƒ½ï¼šå¤œæ™šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶çš„é˜µè¥ï¼Œè¯·åœ¨æŠ•ç¥¨é¢æ¿é€‰æ‹©è¦æŸ¥éªŒçš„ç©å®¶');
                    showVotePanel();
                    // åç»­å¯æ‰©å±•æŸ¥éªŒé€»è¾‘
                    break;
                case 'å¥³å·«':
                    const usePotion = confirm('å¥³å·«æŠ€èƒ½ï¼š\n1. è§£è¯ï¼ˆæ•‘äººï¼‰\n2. æ¯’è¯ï¼ˆæ¯’äººï¼‰\n\næ˜¯å¦ä½¿ç”¨è§£è¯ï¼Ÿï¼ˆå–æ¶ˆåˆ™ä½¿ç”¨æ¯’è¯ï¼‰');
                    alert(`ä½ é€‰æ‹©${usePotion ? 'ä½¿ç”¨è§£è¯' : 'ä½¿ç”¨æ¯’è¯'}ï¼Œè¯·åœ¨æŠ•ç¥¨é¢æ¿é€‰æ‹©ç›®æ ‡ç©å®¶`);
                    showVotePanel();
                    // åç»­å¯æ‰©å±•è§£è¯/æ¯’è¯é€»è¾‘
                    break;
                case 'å®ˆå«':
                    alert('å®ˆå«æŠ€èƒ½ï¼šå¤œæ™šå¯ä»¥å®ˆæŠ¤ä¸€åç©å®¶ï¼Œé˜²æ­¢è¢«ç‹¼äººå‡»æ€ï¼Œè¯·åœ¨æŠ•ç¥¨é¢æ¿é€‰æ‹©è¦å®ˆæŠ¤çš„ç©å®¶');
                    showVotePanel();
                    // åç»­å¯æ‰©å±•å®ˆæŠ¤é€»è¾‘
                    break;
                default:
                    alert('ä½ çš„è§’è‰²æš‚æ— å¯ç”¨æŠ€èƒ½ï¼');
            }
        }

        // è·³è¿‡å›åˆ
        function skipTurn() {
            sendWsMessage({
                type: 'gameAction',
                action: 'skip',
                roomId: currentRoomId,
                playerId: currentUser.id
            });
            addGameLog('ç³»ç»Ÿ', 'ä½ å·²è·³è¿‡æœ¬å›åˆ');
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            sendWsMessage({
                type: 'chatMessage',
                message: message,
                roomId: currentRoomId,
                playerId: currentUser.id
            });

            // æœ¬åœ°æ˜¾ç¤ºæ¶ˆæ¯
            addChatMessage(currentUser.name, message);
            messageInput.value = '';
        }

        // æ·»åŠ æ¸¸æˆæ—¥å¿—
        function addGameLog(sender, content, colorClass = 'white') {
            const gameLogEl = document.getElementById('gameLog');
            const logEl = document.createElement('div');
            logEl.className = `text-${colorClass}`;
            logEl.innerHTML = `<span class="font-medium">${new Date().toLocaleTimeString()}</span> - ${sender}ï¼š${content}`;
            gameLogEl.appendChild(logEl);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            gameLogEl.scrollTop = gameLogEl.scrollHeight;
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(sender, content) {
            const chatAreaEl = document.getElementById('chatArea');
            const messageEl = document.createElement('div');
            messageEl.className = 'flex items-start mb-2';
            messageEl.innerHTML = `
                <span class="font-bold mr-2">${sender}ï¼š</span>
                <span class="text-sm">${content}</span>
            `;
            chatAreaEl.appendChild(messageEl);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatAreaEl.scrollTop = chatAreaEl.scrollHeight;
        }

        // å‘é€WebSocketæ¶ˆæ¯
        function sendWsMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else {
                alert('æœåŠ¡å™¨è¿æ¥ä¸­ï¼Œè¯·ç¨åå†è¯•');
            }
        }

        // æ˜¾ç¤ºè§„åˆ™
        function showRules() {
            document.getElementById('rulesModal').showModal();
        }

        // å…³é—­è§„åˆ™
        function closeRules() {
            document.getElementById('rulesModal').close();
        }

        // é€€å‡ºæ¸¸æˆ
        function exitGame() {
            if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
                // å‘é€ç¦»å¼€æˆ¿é—´æ¶ˆæ¯
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendWsMessage({
                        type: 'leaveRoom',
                        roomId: currentRoomId,
                        playerId: currentUser.id
                    });
                }
                // æ¸…é™¤æ¸¸æˆçŠ¶æ€
                localStorage.removeItem('playerRole');
                localStorage.removeItem('gameState');
                localStorage.removeItem('currentRoomId');
                // è·³è½¬åˆ°åŒ¹é…é¡µé¢
                window.location.href = 'match.html';
            }
        }

        // é¡µé¢å…³é—­æ—¶å‘é€ç¦»å¼€æ¶ˆæ¯
        window.onbeforeunload = function() {
            if (ws && ws.readyState === WebSocket.OPEN && currentRoomId) {
                sendWsMessage({
                    type: 'leaveRoom',
                    roomId: currentRoomId,
                    playerId: currentUser.id
                });
            }
        };
    </script>
</body>
</html>