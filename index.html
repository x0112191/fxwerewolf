<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>狼人杀 - 身份验证</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/daisyui/4.12.10/full.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mobile-input {
            min-height: 44px;
            font-size: 16px;
        }
        .btn-mobile {
            min-height: 44px;
            min-width: 44px;
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .input-success {
            border-color: #22c55e !important;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .toast.show {
            opacity: 1;
        }
        /* 直播间监控样式（匹配原有视觉风格） */
        .room-card {
            transition: all 0.2s ease;
        }
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
        }
        .ban-time-select {
            min-height: 44px;
            font-size: 16px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <!-- 主登录页面 -->
    <div id="loginPage" class="w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">狼人杀</h1>
            <p class="text-white/80 text-sm">身份验证系统</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 shadow-2xl">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-white/90">请输入个人密钥</span>
                </label>
                <div class="join">
                    <input type="password" id="loginKey" placeholder="请输入个人密钥" 
                           class="input input-bordered join-item flex-1 mobile-input text-base">
                    <button type="button" onclick="togglePasswordVisibility('loginKey', 'loginEye')" 
                            class="btn btn-ghost join-item btn-mobile" id="loginEye">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="handleLogin()" class="btn btn-primary join-item btn-mobile">
                        <i class="fas fa-sign-in-alt"></i>
                    </button>
                </div>
                <label class="label">
                    <span class="label-text-alt text-white/70">未创建密钥请点击下方"创建密钥"按钮</span>
                </label>
            </div>
            <div class="space-y-3">
                <button onclick="showCreateKeyPage()" class="btn btn-success w-full btn-mobile">
                    <i class="fas fa-key mr-2"></i>创建密钥
                </button>
                <div class="collapse collapse-arrow bg-white/10 rounded-lg">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title text-white/90 font-medium">
                        更多选项
                    </div>
                    <div class="collapse-content">
                        <button onclick="showAdminLogin()" class="btn btn-ghost btn-sm w-full text-white/80">
                            <i class="fas fa-user-shield mr-2"></i>管理员入口
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建密钥页面 -->
    <div id="createKeyPage" class="w-full max-w-md hidden">
        <div class="text-center mb-6">
            <button onclick="showLoginPage()" class="btn btn-ghost btn-sm text-white mb-4">
                <i class="fas fa-arrow-left mr-2"></i>返回登录
            </button>
            <h2 class="text-2xl font-bold text-white">创建密钥</h2>
        </div>
        <div class="glass-effect rounded-2xl p-6 shadow-2xl">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-white/90">请填写个人姓名</span>
                </label>
                <input type="text" id="userName" placeholder="用于身份标识，非实名亦可" 
                       class="input input-bordered mobile-input text-base" maxlength="10"
                       oninput="validateInput('userName')">
                <label class="label">
                    <span class="label-text-alt text-white/70">姓名与密钥绑定，提交后不可修改</span>
                </label>
            </div>
            <div class="form-control mb-6">
                <label class="label">
                    <span class="label-text text-white/90">请设置个人专属密钥</span>
                </label>
                <div class="join">
                    <input type="password" id="newKey" placeholder="支持数字、字母组合，长度不低于6位" 
                           class="input input-bordered join-item flex-1 mobile-input text-base" minlength="6"
                           oninput="validateInput('newKey')">
                    <button type="button" onclick="togglePasswordVisibility('newKey', 'newKeyEye')" 
                            class="btn btn-ghost join-item btn-mobile" id="newKeyEye">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <button onclick="showConfirmDialog()" class="btn btn-primary w-full btn-mobile">
                <i class="fas fa-check mr-2"></i>确认创建
            </button>
        </div>
    </div>

    <!-- 管理员登录页面 -->
    <div id="adminLoginPage" class="w-full max-w-md hidden">
        <div class="text-center mb-6">
            <button onclick="showLoginPage()" class="btn btn-ghost btn-sm text-white mb-4">
                <i class="fas fa-arrow-left mr-2"></i>返回登录
            </button>
            <h2 class="text-2xl font-bold text-white">管理员验证</h2>
        </div>
        <div class="glass-effect rounded-2xl p-6 shadow-2xl">
            <div class="form-control mb-6">
                <label class="label">
                    <span class="label-text text-white/90">请输入管理员密钥</span>
                </label>
                <div class="join">
                    <input type="password" id="adminKey" placeholder="管理员专属密钥" 
                           class="input input-bordered join-item flex-1 mobile-input text-base">
                    <button type="button" onclick="togglePasswordVisibility('adminKey', 'adminEye')" 
                            class="btn btn-ghost join-item btn-mobile" id="adminEye">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <button onclick="handleAdminLogin()" class="btn btn-warning w-full btn-mobile">
                <i class="fas fa-user-shield mr-2"></i>管理员登录
            </button>
        </div>
    </div>

    <!-- 管理员审核+直播间监控页面（核心新增） -->
    <div id="adminAuditPage" class="w-full max-w-4xl hidden">
        <div class="text-center mb-6">
            <button onclick="showLoginPage()" class="btn btn-ghost btn-sm text-white mb-4">
                <i class="fas fa-arrow-left mr-2"></i>返回登录
            </button>
            <h2 class="text-2xl font-bold text-white">狼人杀管理后台</h2>
        </div>
        
        <!-- 选项卡切换 -->
        <div class="glass-effect rounded-2xl p-6 shadow-2xl mb-4">
            <div class="tabs tabs-lifted tabs-bg-transparent">
                <button onclick="switchTab('audit')" class="tab tab-active text-white">用户审核</button>
                <button onclick="switchTab('live')" class="tab text-white">直播间监控</button>
            </div>
        </div>

        <!-- 用户审核面板 -->
        <div id="auditTab" class="glass-effect rounded-2xl p-6 shadow-2xl mb-4">
            <div class="form-control mb-4">
                <h3 class="text-white/90 font-medium mb-2">待审核用户列表</h3>
                <div id="pendingUsersList" class="bg-white/5 rounded-lg p-2 max-h-60 overflow-y-auto">
                    <!-- 待审核用户会动态加载到这里 -->
                </div>
            </div>
            <div class="form-control mb-4">
                <h3 class="text-white/90 font-medium mb-2">已审核用户列表</h3>
                <div id="approvedUsersList" class="bg-white/5 rounded-lg p-2 max-h-60 overflow-y-auto">
                    <!-- 已审核用户会动态加载到这里 -->
                </div>
            </div>
        </div>

        <!-- 直播间监控面板（核心新增） -->
        <div id="liveTab" class="glass-effect rounded-2xl p-6 shadow-2xl mb-4 hidden">
            <div class="form-control mb-6">
                <h3 class="text-white/90 font-medium mb-3">当前在线房间列表</h3>
                <div id="liveRoomsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-80 overflow-y-auto">
                    <!-- 房间卡片动态加载 -->
                </div>
            </div>
            
            <!-- 封禁操作面板 -->
            <div id="banPanel" class="bg-white/5 rounded-lg p-4 hidden">
                <h4 class="text-white/90 font-medium mb-3 flex items-center">
                    <i class="fas fa-shield-halved mr-2"></i>封禁操作
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label text-white/80">封禁类型</label>
                        <div class="space-y-2">
                            <label class="label cursor-pointer">
                                <input type="radio" name="banType" value="user" class="radio checked:bg-green-500" checked>
                                <span class="label-text text-white">封禁用户</span>
                            </label>
                            <label class="label cursor-pointer">
                                <input type="radio" name="banType" value="room" class="radio checked:bg-green-500">
                                <span class="label-text text-white">封禁房间</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="label text-white/80">封禁时长（分钟）</label>
                        <input type="number" id="banTime" min="1" max="60" value="10" 
                               class="ban-time-select input input-bordered w-full text-base">
                        <p class="text-white/60 text-xs mt-1">最大封禁时长：60分钟</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="confirmBan()" class="btn btn-error btn-mobile flex-1">
                        <i class="fas fa-ban mr-2"></i>确认封禁
                    </button>
                    <button onclick="cancelBan()" class="btn btn-ghost btn-mobile flex-1">
                        <i class="fas fa-times mr-2"></i>取消
                    </button>
                </div>
            </div>
        </div>

        <button onclick="logoutAdmin()" class="btn btn-error w-full btn-mobile">
            <i class="fas fa-sign-out-alt mr-2"></i>退出管理员
        </button>
    </div>

    <!-- 确认对话框 -->
    <dialog id="confirmDialog" class="modal">
        <div class="modal-box bg-white">
            <h3 class="font-bold text-lg text-red-600 mb-4">
                <i class="fas fa-exclamation-triangle mr-2"></i>重要提示
            </h3>
            <p class="text-gray-700 mb-6">
                姓名与密钥一旦确认提交，均无法修改，请务必核对信息并妥善保存密钥，避免遗忘或泄露。
            </p>
            <div class="modal-action">
                <button onclick="createKey()" class="btn btn-primary">
                    <i class="fas fa-check mr-2"></i>确认提交
                </button>
                <button onclick="closeConfirmDialog()" class="btn btn-ghost">
                    <i class="fas fa-arrow-left mr-2"></i>返回修改
                </button>
            </div>
        </div>
    </dialog>

    <!-- 封禁确认对话框 -->
    <dialog id="banConfirmDialog" class="modal">
        <div class="modal-box bg-white">
            <h3 class="font-bold text-lg text-red-600 mb-4">
                <i class="fas fa-exclamation-triangle mr-2"></i>封禁确认
            </h3>
            <p class="text-gray-700 mb-6" id="banConfirmText">
                确认封禁【房间101】的用户【张三】，时长10分钟？
            </p>
            <div class="modal-action">
                <button onclick="executeBan()" class="btn btn-error">
                    <i class="fas fa-ban mr-2"></i>确认封禁
                </button>
                <button onclick="closeBanConfirmDialog()" class="btn btn-ghost">
                    <i class="fas fa-times mr-2"></i>取消
                </button>
            </div>
        </div>
    </dialog>

    <!-- 提示框 -->
    <div id="toast" class="toast">操作提示</div>

    <script>
        // 统一服务器地址（修正为10个6：666.666.666.666）
        const SERVER_URL = '666.666.666.666';
        // 全局变量：当前选中的房间/用户
        let currentSelectedRoom = null;
        let currentSelectedUser = null;

        // ========== 基础页面切换 ==========
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('createKeyPage').classList.add('hidden');
            document.getElementById('adminLoginPage').classList.add('hidden');
            document.getElementById('adminAuditPage').classList.add('hidden');
        }

        function showCreateKeyPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('createKeyPage').classList.remove('hidden');
            document.getElementById('adminLoginPage').classList.add('hidden');
            document.getElementById('adminAuditPage').classList.add('hidden');
        }

        function showAdminLogin() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('createKeyPage').classList.add('hidden');
            document.getElementById('adminLoginPage').classList.remove('hidden');
            document.getElementById('adminAuditPage').classList.add('hidden');
        }

        function showAdminAuditPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('createKeyPage').classList.add('hidden');
            document.getElementById('adminLoginPage').classList.add('hidden');
            document.getElementById('adminAuditPage').classList.remove('hidden');
            loadUserLists(); // 加载用户列表
            loadLiveRooms(); // 加载直播间列表
        }

        // ========== 管理员选项卡切换 ==========
        function switchTab(tabName) {
            // 隐藏所有选项卡
            document.getElementById('auditTab').classList.add('hidden');
            document.getElementById('liveTab').classList.add('hidden');
            // 重置封禁面板
            document.getElementById('banPanel').classList.add('hidden');
            currentSelectedRoom = null;
            currentSelectedUser = null;
            
            // 显示选中的选项卡
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            // 激活对应标签
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('tab-active'));
            event.target.classList.add('tab-active');
        }

        // ========== 工具函数 ==========
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (type === 'error') toast.style.background = 'rgba(239, 68, 68, 0.8)';
            if (type === 'success') toast.style.background = 'rgba(34, 197, 94, 0.8)';
            setTimeout(() => {
                toast.className = 'toast';
            }, 2000);
        }

        function validateInput(inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (inputId === 'userName') {
                if (!value || value.length < 1 || value.length > 10) {
                    input.classList.add('input-error');
                    input.classList.remove('input-success');
                } else {
                    input.classList.remove('input-error');
                    input.classList.add('input-success');
                }
            }
            
            if (inputId === 'newKey') {
                if (!value || value.length < 6) {
                    input.classList.add('input-error');
                    input.classList.remove('input-success');
                } else {
                    input.classList.remove('input-error');
                    input.classList.add('input-success');
                }
            }
        }

        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // ========== 用户审核功能 ==========
        function showConfirmDialog() {
            const userName = document.getElementById('userName').value.trim();
            const newKey = document.getElementById('newKey').value.trim();
            
            if (!userName || userName.length < 1 || userName.length > 10) {
                showToast('请输入1-10位字符的姓名', 'error');
                return;
            }
            
            if (!newKey || newKey.length < 6) {
                showToast('请输入至少6位的密钥', 'error');
                return;
            }
            
            document.getElementById('confirmDialog').showModal();
        }

        function closeConfirmDialog() {
            document.getElementById('confirmDialog').close();
        }

        function createKey() {
            const userName = document.getElementById('userName').value.trim();
            const newKey = document.getElementById('newKey').value.trim();
            
            // Debug：修复重复密钥检测逻辑
            const users = JSON.parse(localStorage.getItem('werewolf_users') || '[]');
            const keyExists = users.some(u => u.key === newKey);
            if (keyExists) {
                showToast('该密钥已被使用，请更换', 'error');
                closeConfirmDialog();
                return;
            }
            
            const userData = {
                name: userName,
                key: newKey,
                status: 'pending',
                createdAt: new Date().toISOString(),
                server: SERVER_URL
            };
            
            users.push(userData);
            localStorage.setItem('werewolf_users', JSON.stringify(users));
            
            closeConfirmDialog();
            showLoginPage();
            setTimeout(() => {
                showToast('姓名与密钥创建成功，请等待管理员审核', 'success');
            }, 300);
        }

        function handleLogin() {
            const key = document.getElementById('loginKey').value.trim();
            
            if (!key) {
                showToast('请输入密钥', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('werewolf_users') || '[]');
            const user = users.find(u => u.key === key);
            
            if (!user) {
                showToast('密钥错误或未注册', 'error');
                return;
            }
            
            if (user.status !== 'approved') {
                showToast('您的申请正在审核中，请耐心等待', 'error');
                return;
            }
            
            localStorage.setItem('current_user', JSON.stringify(user));
            // Debug：修复跳转路径（避免404）
            showToast('登录成功，即将进入游戏', 'success');
            setTimeout(() => {
                window.location.href = 'user.html'; // 保留原有逻辑，实际可替换为游戏页面
            }, 1500);
        }

        function handleAdminLogin() {
            const key = document.getElementById('adminKey').value.trim();
            const adminKeys = ['A', 'admin666', '123456'];
            
            if (adminKeys.includes(key)) {
                sessionStorage.setItem('is_admin', 'true');
                showAdminAuditPage();
                showToast('管理员登录成功', 'success');
            } else {
                showToast('管理员密钥错误', 'error');
            }
        }

        function loadUserLists() {
            const users = JSON.parse(localStorage.getItem('werewolf_users') || '[]');
            const pendingList = document.getElementById('pendingUsersList');
            const approvedList = document.getElementById('approvedUsersList');
            
            pendingList.innerHTML = '';
            approvedList.innerHTML = '';
            
            users.forEach((user, index) => {
                const userItem = document.createElement('div');
                userItem.className = 'flex justify-between items-center p-2 border-b border-white/10 mb-1';
                userItem.innerHTML = `
                    <div>
                        <span class="text-white">${user.name}</span>
                        <span class="text-white/60 text-xs ml-2">(${user.createdAt.slice(0, 10)})</span>
                    </div>
                    <div class="space-x-1">
                        ${user.status === 'pending' ? 
                            `<button onclick="approveUser(${index})" class="btn btn-xs btn-success">通过</button>
                             <button onclick="rejectUser(${index})" class="btn btn-xs btn-error">拒绝</button>` : 
                            `<span class="text-white/70 text-xs">已审核</span>`
                        }
                    </div>
                `;
                
                if (user.status === 'pending') {
                    pendingList.appendChild(userItem);
                } else {
                    approvedList.appendChild(userItem);
                }
            });
            
            if (pendingList.innerHTML === '') {
                pendingList.innerHTML = '<div class="text-white/60 text-center py-4">暂无待审核用户</div>';
            }
            if (approvedList.innerHTML === '') {
                approvedList.innerHTML = '<div class="text-white/60 text-center py-4">暂无已审核用户</div>';
            }
        }

        function approveUser(index) {
            const users = JSON.parse(localStorage.getItem('werewolf_users') || '[]');
            users[index].status = 'approved';
            localStorage.setItem('werewolf_users', JSON.stringify(users));
            showToast('用户审核通过', 'success');
            loadUserLists();
        }

        function rejectUser(index) {
            const users = JSON.parse(localStorage.getItem('werewolf_users') || '[]');
            users.splice(index, 1);
            localStorage.setItem('werewolf_users', JSON.stringify(users));
            showToast('用户审核拒绝（已删除）', 'error');
            loadUserLists();
        }

        function logoutAdmin() {
            sessionStorage.removeItem('is_admin');
            showLoginPage();
            showToast('已退出管理员模式', 'info');
        }

        // ========== 直播间监控+封禁功能（核心新增） ==========
        // 模拟加载在线房间数据
        function loadLiveRooms() {
            // 模拟房间数据（实际可从服务器获取）
            const liveRooms = [
                { id: 101, name: '新手房-101', status: '游戏中', players: 8, maxPlayers: 12, creator: '张三', server: SERVER_URL },
                { id: 102, name: '进阶房-102', status: '等待中', players: 5, maxPlayers: 12, creator: '李四', server: SERVER_URL },
                { id: 103, name: '大神房-103', status: '游戏中', players: 12, maxPlayers: 12, creator: '王五', server: SERVER_URL },
                { id: 104, name: '娱乐房-104', status: '游戏中', players: 7, maxPlayers: 12, creator: '赵六', server: SERVER_URL },
                { id: 105, name: '测试房-105', status: '等待中', players: 2, maxPlayers: 12, creator: '钱七', server: SERVER_URL }
            ];
            
            const roomsList = document.getElementById('liveRoomsList');
            roomsList.innerHTML = '';
            
            liveRooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card glass-effect rounded-xl p-4';
                roomCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-white font-bold">房间 ${room.id}：${room.name}</h4>
                        <span class="badge ${room.status === '游戏中' ? 'badge-warning' : 'badge-success'}">${room.status}</span>
                    </div>
                    <div class="text-white/80 text-sm mb-3">
                        <p><i class="fas fa-users mr-1"></i> ${room.players}/${room.maxPlayers} 人</p>
                        <p><i class="fas fa-user mr-1"></i> 创建者：${room.creator}</p>
                        <p><i class="fas fa-server mr-1"></i> 服务器：${room.server}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="watchRoom(${room.id})" class="btn btn-sm btn-primary flex-1">
                            <i class="fas fa-eye mr-1"></i>观看直播
                        </button>
                        <button onclick="showBanPanel(${room.id}, '${room.name}', '${room.creator}')" class="btn btn-sm btn-error flex-1">
                            <i class="fas fa-ban mr-1"></i>封禁操作
                        </button>
                    </div>
                `;
                roomsList.appendChild(roomCard);
            });
        }

        // 观看房间直播
        function watchRoom(roomId) {
            // 模拟跳转到直播间（实际可对接直播流）
            showToast(`正在进入房间 ${roomId} 直播间...`, 'success');
            // 实际项目中可替换为直播页面链接
            setTimeout(() => {
                window.open(`live.html?roomId=${roomId}&server=${SERVER_URL}`, '_blank');
            }, 1000);
        }

        // 显示封禁面板
        function showBanPanel(roomId, roomName, creator) {
            currentSelectedRoom = { id: roomId, name: roomName, creator: creator };
            document.getElementById('banPanel').classList.remove('hidden');
            // 滚动到封禁面板
            document.getElementById('banPanel').scrollIntoView({ behavior: 'smooth' });
        }

        // 取消封禁操作
        function cancelBan() {
            document.getElementById('banPanel').classList.add('hidden');
            currentSelectedRoom = null;
            currentSelectedUser = null;
            // 重置封禁时长和类型
            document.getElementById('banTime').value = 10;
            document.querySelector('input[name="banType"][value="user"]').checked = true;
        }

        // 确认封禁（显示确认框）
        function confirmBan() {
            if (!currentSelectedRoom) {
                showToast('请先选择要封禁的房间', 'error');
                return;
            }
            
            const banTime = parseInt(document.getElementById('banTime').value);
            const banType = document.querySelector('input[name="banType"]:checked').value;
            
            // 验证封禁时长
            if (isNaN(banTime) || banTime < 1 || banTime > 60) {
                showToast('封禁时长必须为1-60分钟', 'error');
                return;
            }
            
            // 拼接确认文本
            let confirmText = '';
            if (banType === 'user') {
                confirmText = `确认封禁【房间${currentSelectedRoom.id}】的创建者【${currentSelectedRoom.creator}】，时长${banTime}分钟？`;
            } else {
                confirmText = `确认封禁【房间${currentSelectedRoom.id}：${currentSelectedRoom.name}】，时长${banTime}分钟？`;
            }
            
            document.getElementById('banConfirmText').textContent = confirmText;
            document.getElementById('banConfirmDialog').showModal();
        }

        // 关闭封禁确认框
        function closeBanConfirmDialog() {
            document.getElementById('banConfirmDialog').close();
        }

        // 执行封禁操作
        function executeBan() {
            const banTime = parseInt(document.getElementById('banTime').value);
            const banType = document.querySelector('input[name="banType"]:checked').value;
            
            // 模拟执行封禁（实际可调用服务器接口）
            let banLog = {
                type: banType,
                target: banType === 'user' ? currentSelectedRoom.creator : `房间${currentSelectedRoom.id}`,
                time: banTime,
                operator: '管理员',
                timeStamp: new Date().toISOString(),
                server: SERVER_URL
            };
            
            // 保存封禁日志
            const banLogs = JSON.parse(localStorage.getItem('werewolf_ban_logs') || '[]');
            banLogs.push(banLog);
            localStorage.setItem('werewolf_ban_logs', JSON.stringify(banLogs));
            
            // 关闭弹窗+提示
            closeBanConfirmDialog();
            cancelBan();
            
            if (banType === 'user') {
                showToast(`已封禁用户【${currentSelectedRoom.creator}】${banTime}分钟`, 'success');
            } else {
                showToast(`已封禁房间【${currentSelectedRoom.id}】${banTime}分钟`, 'success');
            }
            
            // 重新加载房间列表（模拟封禁后房间下线）
            setTimeout(() => {
                loadLiveRooms();
            }, 1000);
        }

        // ========== 初始化+Debug修复 ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Debug：修复重复登录跳转问题
            const currentUser = localStorage.getItem('current_user');
            if (currentUser) {
                showToast('检测到已登录状态，即将进入游戏', 'info');
                setTimeout(() => {
                    window.location.href = 'user.html';
                }, 1500);
                return;
            }
            
            const isAdmin = sessionStorage.getItem('is_admin');
            if (isAdmin === 'true') {
                showAdminAuditPage();
            }

            // Debug：修复移动端输入框聚焦问题
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    window.scrollTo(0, 0);
                });
            });
        });
    </script>
</body>
</html>
